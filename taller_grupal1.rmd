---
title: "P FINAL QOG"
author: " Rubén Díaz y Jorge de Diego"
date: "2024-01-16"
output: 
  html_document:
    theme: cerulean
    toc: yes
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PROYECTO DE TALLERES GRUPAL

El siguiente código es un archivo RMD sobre el proyecto de estudio de regresión lineal mediante el uso de la las librerías expuestas y explicadas en clase: tidyverse, dplyr, tidyr, forcats, etc.

## Librerías

```{r}
library(pacman)
p_load(tidyverse, dplyr, forcats, haven, stargazer, readxl, tidyr, car)
```

## Descarga de datos QoG

```{r}
df <- read_dta("qog_std_cs_jan23_stata14.dta") #Usando la Cross-Section del QoG
```


## Especificación de variables.

### Variable dependiente: índice de globalización (continua numérica)

```{r}
df <- df |>
 rename(glob_index = dr_ig)#Recodificamos con la función rename de dplyr

summary(df$glob_index) #Visualizamos si la variable está correctamente especificada

#Podríamos eliminar los casos perdidos ahora, pero se hará posteriormente de forma más óptima.
```

### Variables independientes

#### Variables sociodemográficas (vinculadas al Modelo 1 y 2)

**DIVERSIDAD CULTURAL**: variable continua. A mayor número, más fragmentación cultural detectada en un país.

```{r}
df <- df |> 
 rename(cult_div = fe_cultdiv) #Repetimos el proceso

summary(df$cult_div) #Visualizamos.
```

**ESTABILIDAD POLÍTICA**: variable continua que vamos a dicotomizar para determinar 2 categorias: estabilidad / inestabilidad

```{r}
 df <- df |> 
 rename(estabilidad = wbgi_pve) |> 
 mutate(estabilidad = #Con mutate cambiamos los valores de nuestra variable
         case_when(estabilidad >=0 ~ "Estable", #Donde valores positivos implican una política estable
                   estabilidad < 0 ~ "Inestable", #Y valores negativos lo contrario: inestabilidad. 
                   estabilidad == "NA" ~ NA)) |>
 mutate(estabilidad = factor(estabilidad))
 
table(df$estabilidad) #Visualizamos, esta vez con table(), que se ha ajustado bien la variable.

```

**REGÍMEN DEMOCRÁTICO**: variable dicotómica categorización como regímen democrático o no democrático.

```{r}
df <- df |> 
  rename(demo = bmr_dem) |> 
  mutate(demo = case_when(
    demo == 0 ~ "No democrático",
    demo == 1 ~ "Democrático"
  ))
```

**DERECHOS POLÍTICOS**: variable discreta de 1 (más libre) a 7 (menos libre)

```{r}
df <- df |> 
  mutate(derechos = abs(fh_pr-8) #Invertimos el orden (restando 8 y calculando en valores absolutos), para que un mayor número implique más derechos y el análisis posterior sea más sencillo
  )

summary(df$derechos)
```

#### Variables económicas (Vinculadas al Modelo 3)

**ÍNDICE DE GINI**: variable continua, sirve como indicador de desigualdad.

```{r}
df <- df |> 
 rename(cgini = wdi_gini)
  summary(df$cgini)
```

**PIB PER CAPITA**: variable continua.

```{r}
df <- df |> 
 rename(gdpxcap = wdi_gdpcapcur)

summary(df$gdpxcap)

```

**IDH**: variable continua que categorizamos en 2 tramos: alto, bajo.

```{r}
summary(df$undp_hdi) #Siendo 0,74 la mediana para esta variable, podemos dividir en dos a los países
df <- df |> 
 rename(idh = undp_hdi) |> 
 mutate(idh = case_when(idh < 0.74 ~ "Bajo", #Los valores inferiores a esta media se consideran IDH Bajo
                        idh >= 0.74 ~ "Alto")) #Y por encima, IDH alto.

table(df$idh)
```


##### Inclusión de una nueva base de datos con 2 variables económicas extraídas del banco de datos del Banco Mundial

```{r}
df_logistics <- read_xlsx("df_logistics.xlsx") #Cargamos nuestro EXCEL.
```

Efectuamos la unión de los dataframes en uno nuevo. 

```{r}
df_merged <- right_join(df, df_logistics, by = "ccodealp") #Usamos el código del país como referencia para la unión de los datos, pues los nombre de algunos países usando "cnames" es distinto en la QoG y en los datos del Banco Mundial.
```

**% DEL PIB QUE CORRESPONDE AL COMERCIO**: Para incluirla la especificamos previamente

```{r}
df_merged <- df_merged |> 
 rename(trade_gdp_percent = `trade % gdp`) |> 
 mutate(trade_gdp_percent = as.numeric(trade_gdp_percent)) #Se transforma en variable numérica.
```
**CALIDAD LOGÍSTICA DEL PAÍS**: variable continua donde 1 es la calidad logística más baja y 5 la más alta.

```{r}
df_merged <- df_merged |> 
 mutate(logistics_quality = as.numeric(logistics_quality)) #Se transforma en variable numérica.

```

#### Limpiamos Casos Perdidos.

Una vez hemos especificado todas las variables con las que vamos a trabajar, es momento de eliminar aquellos objetos que no presentan datos en alguna de estas variables.
Esto se justifica porque, de lo contrario, los modelos planteados tendrían un número distinto de casos y no serían, por tanto, comparables entre sí.

```{r}
myvars <- c("glob_index", "cult_div", "estabilidad", "demo", "derechos", "cgini", "idh", "logistics_quality", "trade_gdp_percent")  
df_models<-df_merged[myvars]
df_models<- na.omit(df_models)
```

## Estimación de los Modelos.
### Modelo 1 (Regresión simple)
Hacemos una regresión simple para ver la relación y el impacto de la diversidad cultural sobre cuan globalizado está un país.

```{r}
modelo1 <- lm(glob_index ~ cult_div, data = df_models) #Creamos el Modelo 1 donde establecemos una regresión lineal con el índice de globalización como variable dependiente y la fragmentación cultural como variable dependiente.

summary(modelo1) #Visualizamos: podemos rechazar H0 y aceptar que hay una relación significativa (con un nivel de confianza del 99.9%) y negativa.
```

### Modelo 2 (Regresión multivariante con variables sociodemográficas)
```{r}
modelo2 <- lm(glob_index ~ cult_div + estabilidad + demo + derechos, data = df_models) #No visualizamos los modelos porque se hará posteriormente de forma conjunta; optimizamos espacio y facilitamos la lectura.
```

### Modelo 3 (Regresión multivariante con variables sociodem. y económicas)

```{r}
modelo3 <- lm(glob_index ~ cult_div + estabilidad + demo + derechos + cgini + idh + logistics_quality + trade_gdp_percent , data = df_models)
```

### Modelo 4 (Interacción)
```{r}
modelo4 <- lm(glob_index ~ trade_gdp_percent * idh, data = df_models)

```

```{r}
stargazer(modelo1, modelo2, modelo3, modelo4,
          type = "text",
          style = "apsr",
          column.labels = c("Modelo 1", "Modelo 2", "Modelo 3", "Modelo 4"),
          dep.var.labels = c("Índice de globalización de KOF"),
          covariate.labels = c("Diversidad cultural", "Estabilidad política: Inestable", "Existencia de democracia: No.", "Derechos políticos", "Coef. Gini", "IDH: Bajo", "Calidad de la logística", "% PIB Comercio * IDH Bajo", "% PIB Comercio", "Constante"))
```
###Comprobación de la calidad de los modelos

Comprobamos la multicolinealidad

```{r}
VIF_Modelo2 <- vif(modelo2) #Para el Modelo 1 no es necesario calcular estos valores (solo hay 1 variable explicativa)
print(VIF_Modelo2)  #Visualizamos: valores menores de 5 no deberían preocuparnos.
```

```{r}
VIF_Modelo3 <- vif(modelo3) #La variable derechos políticos daría algunos pequeños problemas de colinealidad.
print(VIF_Modelo3)
```

```{r}
VIF_Modelo4 <- vif(modelo4)
print(VIF_Modelo4)
```

```{r}
p_load(gvlma)  #Añadimos librería para comprobar el modelo.
modelo2_hipo <- gvlma(modelo2)
summary(modelo2_hipo)
```
```{r}
modelo3_hipo <- gvlma(modelo3)
summary(modelo3_hipo)
```


## FORMATO DE DATOS

Cambiamos el formato de datos

```{r}
df_long <- df_merged |> 
  mutate(idh = as.character(idh),
         glob_index = as.character(estabilidad)) |> 
  pivot_longer(
    cols = c(idh, estabilidad),
    names_to = "variables",
    values_to = "valor"
  )
 
```

