---
title: "P FINAL QOG"
author: "Rubén Díaz y Jorge de Diego"
date: "2024-01-16"
output: 
  html_document:
    theme: cerulean
    toc: yes
---
<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# PROYECTO DE TALLERES GRUPAL

El siguiente código es un archivo RMD sobre el proyecto de estudio de regresión lineal mediante el uso de la las librerías expuestas y explicadas en clase: tidyverse, dplyr, tidyr, forcats, etc.

## Librerías

```{r}
library(pacman)
p_load(tidyverse, dplyr, forcats, haven, stargazer, readxl, tidyr, car)
```

## Descarga de datos QoG

```{r}
df <- read_dta("qog_std_cs_jan23_stata14.dta") #Usando la Cross-Section del QoG
```


## Especificación de variables.

### Variable dependiente: índice de globalización (continua numérica)

```{r}
df <- df |>
 rename(glob_index = dr_ig)#Recodificamos con la función rename de dplyr

summary(df$glob_index) #Visualizamos si la variable está correctamente especificada

#Podríamos eliminar los casos perdidos ahora, pero se hará posteriormente de forma más óptima.
```

### Variables independientes

#### Variables sociodemográficas (vinculadas al Modelo 1 y 2)

**DIVERSIDAD CULTURAL**: variable continua. A mayor número, más fragmentación cultural detectada en un país.

```{r}
df <- df |> 
 rename(cult_div = fe_cultdiv) #Repetimos el proceso

summary(df$cult_div) #Visualizamos.
```

**ESTABILIDAD POLÍTICA**: variable continua que vamos a dicotomizar para determinar 2 categorias: estabilidad / inestabilidad

```{r}
 df <- df |> 
 rename(estabilidad = wbgi_pve) |> 
 mutate(estabilidad = #Con mutate cambiamos los valores de nuestra variable
         case_when(estabilidad >=0 ~ "Estable", #Donde valores positivos implican una política estable
                   estabilidad < 0 ~ "Inestable", #Y valores negativos lo contrario: inestabilidad. 
                   estabilidad == "NA" ~ NA)) |>
 mutate(estabilidad = factor(estabilidad))
 
table(df$estabilidad) #Visualizamos, esta vez con table(), que se ha ajustado bien la variable.

```

**REGÍMEN DEMOCRÁTICO**: variable dicotómica categorización como regímen democrático o no democrático.

```{r}
df <- df |> 
  rename(demo = bmr_dem) |> 
  mutate(demo = case_when(
    demo == 0 ~ "No democrático",
    demo == 1 ~ "Democrático"
  ))
```

**DERECHOS POLÍTICOS**: variable discreta de 1 (más libre) a 7 (menos libre)

```{r}
df <- df |> 
  mutate(derechos = abs(fh_pr-8) #Invertimos el orden (restando 8 y calculando en valores absolutos), para que un mayor número implique más derechos y el análisis posterior sea más sencillo
  )

summary(df$derechos)
```

#### Variables económicas (Vinculadas al Modelo 3)

**ÍNDICE DE GINI**: variable continua, sirve como indicador de desigualdad.

```{r}
df <- df |> 
 rename(cgini = wdi_gini)
  summary(df$cgini)
```

**PIB PER CAPITA**: variable continua.

```{r}
df <- df |> 
 rename(gdpxcap = wdi_gdpcapcur)

summary(df$gdpxcap)

```

**IDH**: Índice de Desarrollo Humano, variable continua que categorizamos en 2 tramos: alto, bajo.

```{r}
summary(df$undp_hdi) #Siendo 0,74 la mediana para esta variable, podemos dividir en dos a los países
df <- df |> 
 rename(idh = undp_hdi) |> 
 mutate(idh = case_when(idh < 0.74 ~ "Bajo", #Los valores inferiores a esta media se consideran IDH Bajo
                        idh >= 0.74 ~ "Alto")) #Y por encima, IDH alto.

table(df$idh)
```


##### Inclusión de una nueva base de datos con 2 variables económicas extraídas del banco de datos del Banco Mundial

```{r}
df_logistics <- read_xlsx("df_logistics.xlsx") #Cargamos nuestro EXCEL.
```

Efectuamos la unión de los dataframes en uno nuevo. 

```{r}
df_merged <- right_join(df, df_logistics, by = "ccodealp") #Usamos el código del país como referencia para la unión de los datos, pues los nombre de algunos países usando "cnames" es distinto en la QoG y en los datos del Banco Mundial.
```

**% DEL PIB QUE CORRESPONDE AL COMERCIO**: Para incluirla la especificamos previamente

```{r, warning= FALSE} 
df_merged <- df_merged |> 
 rename(trade_gdp_percent = `trade % gdp`) |> 
 mutate(trade_gdp_percent = as.numeric(trade_gdp_percent)) #Se transforma en variable numérica.
```

**CALIDAD LOGÍSTICA DEL PAÍS**: variable continua donde 1 es la calidad logística más baja y 5 la más alta.

```{r, warning= FALSE}
df_merged <- df_merged |> 
 mutate(logistics_quality = as.numeric(logistics_quality)) #Se transforma en variable numérica.

```

#### Limpiamos Casos Perdidos.

Una vez hemos especificado todas las variables con las que vamos a trabajar, es momento de eliminar aquellos objetos que no presentan datos en alguna de estas variables.
Esto se justifica porque, de lo contrario, los modelos planteados tendrían un número distinto de casos y no serían, por tanto, comparables entre sí.

```{r}
myvars <- c("glob_index", "cult_div", "estabilidad", "demo", "derechos", "cgini", "idh", "logistics_quality", "trade_gdp_percent")  #Agrupamos las variables que deseamos dentro de los modelos.
df_models<-df_merged[myvars] #Creamos un nuevo Data Frame con ellas
df_models<- na.omit(df_models) #Omitimos los casos perdidos con na.omit()
```

## Estimación de los Modelos.
### Modelo 1 (Regresión simple)
Hacemos una regresión simple para ver la relación entra la diversidad cultural sobre cuan globalizado está un país.

```{r}
modelo1 <- lm(glob_index ~ cult_div, data = df_models) #Creamos el Modelo 1 donde establecemos una regresión lineal con el índice de globalización como variable dependiente y la fragmentación cultural como variable dependiente.

summary(modelo1) #Visualizamos: podemos rechazar H0 y aceptar que hay una relación significativa (con un nivel de confianza del 99.9%) y negativa.
```

### Modelo 2 (Regresión multivariante con variables sociodemográficas)
```{r}
modelo2 <- lm(glob_index ~ cult_div + estabilidad + demo + derechos, data = df_models) #No visualizamos todos los modelos porque se hará posteriormente de forma conjunta; optimizamos espacio y facilitamos la lectura.
```

### Modelo 3 (Regresión multivariante con variables sociodem. y económicas)

```{r}
modelo3 <- lm(glob_index ~ cult_div + estabilidad + demo + derechos + cgini + idh + logistics_quality + trade_gdp_percent , data = df_models)
```

### Modelo 4 (Interacción)

```{r}
modelo4 <- lm(glob_index ~ trade_gdp_percent * idh, data = df_models)
```

#### Visualización de los Modelos (1-4)

```{r}
stargazer(modelo1, modelo2, modelo3, modelo4, #Definimos los modelos que queremos que aparezcan
          type = "text",
          style = "apsr", #Elegimos el estilo académico de la Political Science Review
          column.labels = c("Modelo 1", "Modelo 2", "Modelo 3", "Modelo 4"),
          dep.var.labels = c("Índice de globalización de KOF"), #Nombramos la V.D
          covariate.labels = c("Diversidad cultural", "Estabilidad política: Inestable", "Existencia de democracia: No.", "Derechos políticos", "Coef. Gini", "IDH: Bajo", "Calidad de la logística", "% PIB Comercio * IDH Bajo", "% PIB Comercio", "Constante")) #Nombramos las etiquetas.
```

### Comprobación de la calidad de los modelos

#### Comprobamos la multicolinealidad (valores VIF)

```{r}
VIF_Modelo2 <- vif(modelo2) #Para el Modelo 1 no es necesario calcular estos valores (solo hay 1 variable explicativa)
print(VIF_Modelo2)  #Visualizamos: valores menores de 5 no deberían preocuparnos.
```

```{r}
VIF_Modelo3 <- vif(modelo3) #La variable derechos políticos darían algunos pequeños problemas de multicolinealidad.
print(VIF_Modelo3)
```

```{r, warning = FALSE}
VIF_Modelo4 <- vif(modelo4)
print(VIF_Modelo4)
```

#### Comprobación de normalidad, curtosis, homocedasticidad, etc. (Librería GVLMA)

```{r}
p_load(gvlma)  #Añadimos la librería para comprobar el modelo.
modelo2_hipo <- gvlma(modelo2)
summary(modelo2_hipo)
```

```{r}
modelo3_hipo <- gvlma(modelo3)
summary(modelo3_hipo)
```


## Formato de datos.

Añadimos la base de datos con series temporales (del QoG) para poner los datos anualizados.

```{r}
df_ts <- read_dta("qog_std_ts_jan23_stata14.dta") #Cargamos datos
```

Modificamos la base de datos quedándonos sólo los valores que queremos (glob_index y cname)

```{r}
df_ts <- df_ts |> 
 rename(glob_index = dr_ig) |> 
 select(cname, year, glob_index, ccodealp) |> 
 filter(glob_index != "NA")
 
head(df_ts)
```

Cambiamos el fromato de los datos de largo a ancho con pivot_wider de la librería "tidyr"

```{r}
df_ts <- df_ts |> 
 pivot_wider(names_from = year, values_from = glob_index) #Cambiamos la unidad de observación de año-país a país

filter(df_ts, cname == "Spain" | cname == "France") #Visualizamos los datos en formato correcto para España y Francia
```


### Tabla de descriptivos

Sacamos una tabla de descriptivos de todas las variables para el trabajo, usaremos summary y despues visualizaremos los datos de los coeficientes de nuestro modelo más amplio (Modelo 3)

```{r, warning= FALSE}
#Instalamos el paquete knitr para hacer una tabla estética
p_load(knitr)

df_descriptivos <- df_models |> 
 mutate(estabilidad = as.numeric(estabilidad)) |> #Para ver los descriptivos, primero cambiamos a numéricas las variables que no lo son
 mutate(demo = as.numeric(demo)) |> 
 mutate(idh = as.numeric(idh))

descriptivos_table <- sapply(df_descriptivos, function(x) c(Mínimo = min(x), Máximo = max(x), Media = mean(x), Mediana = median(x), SD = sd(x))) #Ajustamos los valores deseados, mínimo, máximo, media, etc.

descriptivos_table <- t(descriptivos_table)

descriptives_table1 <- kable(descriptivos_table, format = "html", digits = 3)

descriptives_table1
```

```{r}
df_ts_red <- df_ts |> select(cname, ccodealp, "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020")
```


```{r}
df_pib_hist <- read_xls("pib_com_historico.xls")
df_pib_hist<- na.omit(df_pib_hist) #Eliminamos NA 
```

```{r}
df_pib_hist <- df_pib_hist |> rename(ccodealp = `Country Code`)
```

```{r}
df_graph1 <- right_join(df_ts_red, df_pib_hist, by = "ccodealp")
df_graph1 <- na.omit(df_graph1)

```

```{r}
summary(df_graph1)
```


```{r}
df_graph1 |> pivot_longer(df_graph1,
                          names_to = "year",
                          values_to = "valores")

```


## Margins

```{r}
p_load(margins)
margins_m1 <- margins(modelo1)
margins_m2 <- margins(modelo2)
margins_m3 <- margins(modelo3)
```

```{r}
p_load(jtools)
plot_summs(margins_m2, style = "dotplot", scale = TRUE, ci = TRUE, model.names = c("Modelo 2"), colors = c("blue"), 
coefs = c("Diversidad cultural" = "cult_div", 
"Existencia de democracia: No." = "demoNo Democrático", 
"Derechos políticos" = "derechos",
"Estabilidad política: Inestable" = "estabilidadInestable")) + ggplot2::theme_minimal()+
  ggplot2::theme(legend.position = "right", plot.title = element_text(hjust = 0.5)) +
ggplot2::labs(title = "Modelo Marginal 1") + 
  ggplot2::ylab("Categorías") +
  ggplot2::xlab("Marginal estimado")
```

```{r}
plot_summs(margins_m3, style = "dotplot", scale = TRUE, ci = TRUE, model.names = c("Modelo 3"), colors = c("blue"),
coefs = c("Coeficiente de Gini" = "cgini",
  "Diversidad cultural" = "cult_div", 
"Existencia de democracia: No." = "demoNo Democrático", 
"Derechos políticos" = "derechos",
"Estabilidad política: Inestable" = "estabilidadInestable",
"IDH: Bajo" = "idhBajo",
"Calidad de la logística" = "logistics_quality",
"% del PIB que representa el comercio" = "trade_gdp_percent"))  + ggplot2::theme_minimal()+
  ggplot2::theme(legend.position = "right", plot.title = element_text(hjust = 0.5)) +
ggplot2::labs(title = "Modelo Marginal 3") + 
  ggplot2::ylab("Categorías") +
  ggplot2::xlab("Marginal estimado")
```

